let ws=new WebSocket("ws://localhost:9090");var clientId;ws.addEventListener("close",function(){"flex"!=document.getElementById("criticalError").style.display&&"flex"!=document.getElementById("endGameCont").style.display&&setTimeout(function(){criticalError("An unknown error occurred")},500)}),ws.onmessage=(e=>{const t=JSON.parse(e.data);if(console.log(t.method),"connected"==t.method)clientId=t.clientId;else if("created"==t.method)me=t.you,showLaunchScreen(t.game.joinCode);else if("joined"==t.method)me=t.you,showLaunchScreen(document.getElementById("joinInput").value),document.getElementById("startGame").style.display="none",document.getElementById("joinPage").style.display="none";else if("playerupdate"==t.method)updatePlayerTabs(t.players);else if("renamed"==t.method)me=t.you;else if("error"==t.method)error(t.text);else if("criticalerror"==t.method)criticalError(t.text);else if("launched"==t.method){turn=t.turn,launchGame();let e=document.getElementsByClassName("playerScore");for(let t of e)t.textContent="-2PTS"}else if("dealt"==t.method){hand=hand.concat(t.cards);for(let e of t.cards)createCard(e,useSuit,document.getElementsByClassName("cardHalf")[1])}else if("tablecards"==t.method)for(let e of t.cards)createCard(e,useSuit,document.getElementsByClassName("cardHalf")[0]);else if("nextturn"==t.method)resetCards(),changeTurn(t.player);else if("message"==t.method)document.getElementById("message").textContent=t.message;else if("removedraw"==t.method)document.getElementById("actionCont").children[0].remove(),document.getElementById("message").textContent="There are no more cards in the draw pile";else if("removefromhand"==t.method){for(let e of t.cards)hand=bubble(hand,e);removeCards(t.cards,document.getElementsByClassName("cardHalf")[1])}else"removefromtable"==t.method?removeCards(t.cards,document.getElementsByClassName("cardHalf")[0]):"scoreupdate"==t.method?updateScore(t.scores):"endofgame"==t.method?endGame(t):console.log(t)});var me,opponents,turn,useSuit=!1,cycleInterval=!1,carousel=0,gameLaunched=!1,hand=[],primed=!1,selected=[],challenge={player:void 0,value:void 0},steal={firstCard:void 0,name:void 0},oppoSets=[];function endGame(e){document.getElementById("endGameCont").style.display="flex",document.getElementById("endGameMess").textContent=e.message;for(let t of e.scores){let e=document.createElement("DIV");e.classList.add("finalScoreCont");let n=document.createElement("DIV");n.textContent=t.name,n.style.backgroundColor=`var(--player${t.index})`,n.classList.add("finalScoreName");let l=document.createElement("DIV");l.classList.add("finalScoreNumber"),l.textContent=t.score+plural("PT",t.score),l.style.color=`var(--player${t.index})`,e.append(n),e.append(l),document.getElementById("endGameScores").append(e)}}function cyclePlayers(){!1===cycleInterval&&(cycleInterval=setInterval(function(){carousel++;var e=document.getElementsByClassName("playerScoreCont"),t=document.getElementsByClassName("playerTab");carousel>=e.length&&(carousel=0);for(let n=0;n<e.length;n++)n==carousel?(e[n].style.display="flex",t[n].style.borderTopColor="currentColor"):(e[n].style.display="none",t[n].style.borderTopColor="#777")},7e3))}function goToPlayer(e){e=Number(e),carousel=e,clearInterval(cycleInterval),cycleInterval=!1;var t=document.getElementsByClassName("playerScoreCont"),n=document.getElementsByClassName("playerTab");for(let l=0;l<t.length;l++)l==e?(t[l].style.display="flex",n[l].style.borderTopColor="currentColor"):(t[l].style.display="none",n[l].style.borderTopColor="#777");setTimeout(cyclePlayers,5e3)}function launchGame(){if(gameLaunched=!0,document.getElementById("startGameCont").style.display="none",updatePlayerTabs(opponents),turn!=me.name){for(let e of document.getElementsByClassName("playButton"))e.classList.add("disabled");document.getElementsByClassName("confirmButton")[0].classList.add("disabled")}setTimeout(cyclePlayers,3e3)}function requestLaunch(){let e={method:"launch",clientId:clientId};ws.send(JSON.stringify(e))}function requestGame(){let e={method:"create",clientId:clientId};ws.send(JSON.stringify(e))}function showLaunchScreen(e){document.getElementById("initPage").style.display="none",document.getElementById("launchPage").style.display="block",document.getElementById("joinCode").textContent=`Join Code: ${e}`,document.getElementById("nameChange").value=me.name}function showJoinScreen(){document.getElementById("joinInput").value="",document.getElementById("initPage").style.display="none",document.getElementById("joinPage").style.display="block",document.getElementById("joinInput").focus()}function askToJoin(){var e=document.getElementById("joinInput").value;if(6==String(e).length){let t={method:"join",joinCode:Number(e),clientId:clientId};setTimeout(function(){ws.send(JSON.stringify(t))},300)}else String(e).length>6&&(document.getElementById("joinInput").value=String(e.substring(0,6)))}function updatePlayerTabs(e){if(opponents=e,gameLaunched){let t=document.getElementById("playerCarousel");t.innerHTML="";let n=document.getElementById("playerScores");n.innerHTML="";for(let l in e){let a=document.createElement("DIV");a.addEventListener("click",function(){goToPlayer(l)}),a.classList.add("playerTab"),e[l].name==turn?a.textContent=decodeEntities(e[l].name+" &middot;"):a.textContent=e[l].name,e[l].name==me.name&&(a.style.textDecoration="underline"),l==carousel&&(a.style.borderTopColor="currentColor"),t.append(a);let o=document.createElement("DIV");o.classList.add("playerScoreCont"),l==carousel&&(o.style.display="flex");let s=document.createElement("DIV");s.classList.add("playerScore");let r=document.createElement("DIV");r.classList.add("playerSets"),o.append(s),o.append(r),n.append(o)}updateScore(e)}else{let t=document.getElementById("joinedPlayers").children;for(let n=0;n<e.length;n++)t[n].textContent=e[n].name,t[n].style.display="block";for(let n=e.length;n<6;n++)t[n].style.display="none"}}function updateScore(e){let t=document.getElementsByClassName("playerScoreCont");oppoSets.length=0;for(let n=0;n<t.length;n++){t[n].children[0].textContent=`${e[n].score}${plural("PT",e[n].score)}`,t[n].children[1].innerHTML="";let l={name:e[n].name,sets:e[n].inSet};oppoSets.push(l);for(let l of e[n].inSet){let e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("viewBox","0 0 24 24"),e.style.fill=cardColors[l[0]%13];let a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",cardIcons[l[0]%13]),e.append(a),t[n].children[1].append(e),newSpan=document.createElement("SPAN"),newSpan.textContent=decodeEntities(`&times;${l.length}`),t[n].children[1].append(newSpan)}}}function requestRename(){let e=document.getElementById("nameChange").value;if(e.length>12)error("Name cannot be longer than 12 characters");else{let t={method:"rename",newName:e,clientId:clientId};ws.send(JSON.stringify(t))}}function requestDraw(){if(document.getElementsByClassName("cardHalf")[1].children.length>=7)return void error("You cannot draw with 6 or more cards in hand.");let e={method:"draw",clientId:clientId};ws.send(JSON.stringify(e))}function changeTurn(e){challenge.player=void 0,challenge.value=void 0,steal.firstCard=void 0,steal.name=void 0,primed=!1,document.getElementById("challengeCont").style.display="none",document.getElementById("stealCont").style.display="none";let t=document.getElementsByClassName("playerTab");for(let n in opponents)opponents[n].name==e?t[n].textContent=decodeEntities(opponents[n].name+" &middot;"):t[n].textContent=opponents[n].name;if((turn=e)!=me.name){for(let e of document.getElementsByClassName("playButton"))e.classList.add("disabled");document.getElementsByClassName("confirmButton")[0].classList.add("disabled")}else{for(let e of document.getElementsByClassName("playButton"))e.classList.remove("disabled");hand.length>=7&&document.getElementsByClassName("playButton")[0].classList.add("disabled")}}function prime(e){if(document.getElementsByClassName("confirmButton")[0].classList.remove("disabled"),primed=e,turn!=me.name)return void error("It is not your turn.");let t;switch(document.getElementById("challengeCont").style.display="none",document.getElementById("stealCont").style.display="none",e){case"takeplay":t="Choose at least two cards on screen, then press confirm.";break;case"challenge":t="Choose who and for what card to challenge, then press confirm.",document.getElementById("challengeCont").style.display="block",goToChallenge();break;case"steal":t="Choose another player's set to steal, then press confirm.",document.getElementById("stealCont").style.display="block",goToSteal();break;default:t="WTF"}document.getElementById("message").textContent=t}function goToSteal(){let e=document.getElementById("stealFlex");e.innerHTML="";let t=[];for(let e of hand)t.push(e%13);for(let n of oppoSets){let l=document.createElement("DIV"),a=document.createElement("SPAN");a.textContent=n.name,l.append(a),e.append(l);for(let e of n.sets){let a=e[0]%13;if(0==t.includes(a))continue;let o=document.createElement("DIV");o.classList.add("stealRow");let s=document.createElement("DIV");s.setAttribute("data-first",e[0]),s.setAttribute("data-name",n.name),s.classList.add("stealBox"),s.addEventListener("click",function(){selectSteal(this)}),s.style.color=cardColors[a];let r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox","0 0 24 24");let d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",cardIcons[a]),r.append(d);let c=document.createElement("DIV");c.textContent=decodeEntities(`&times;${e.length}`),s.append(r),s.append(c),o.append(s),l.append(o)}}}function goToChallenge(){let e=document.getElementsByClassName("challengeRow");e[0].innerHTML="",e[1].innerHTML="";for(let t of opponents){if(t.name==me.name)continue;let n=document.createElement("DIV");n.textContent=t.name,n.addEventListener("click",function(){selectChallenge(0,this)}),e[0].append(n)}for(let t of document.getElementsByClassName("cardHalf")[1].children){if(!t.classList.contains("card"))continue;let n=Number(t.getAttribute("data-value")),l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.style.fill=cardColors[n],l.setAttribute("data-value",n),l.setAttribute("viewBox","0 0 24 24"),l.addEventListener("click",function(){selectChallenge(1,this)});let a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",cardIcons[n]),l.append(a),e[1].append(l)}}function selectChallenge(e,t){let n=document.getElementsByClassName("challengeRow")[e];for(let e of n.children)e.classList.remove("selected");t.classList.add("selected"),0===e?challenge.player=t.textContent:challenge.value=Number(t.getAttribute("data-value"))}function selectSteal(e){let t=document.getElementsByClassName("stealBox");for(let e of t)e.classList.remove("selected");e.classList.add("selected"),steal.firstCard=Number(e.getAttribute("data-first")),steal.name=e.getAttribute("data-name")}function resetCards(){selected.length=0,primed=!1;for(let e of document.getElementsByClassName("cardHalf")[0].children)e.style.border="none",e.setAttribute("data-selected","false");for(let e of document.getElementsByClassName("cardHalf")[1].children)e.style.border="none",e.setAttribute("data-selected","false")}function selectCard(e){0!=primed&&turn==me.name&&("false"==e.getAttribute("data-selected")&&0==selected.length?(e.setAttribute("data-selected","true"),e.style.border="2px solid white",selected.push(Number(e.getAttribute("data-id")))):"false"==e.getAttribute("data-selected")?Number(e.getAttribute("data-value"))==selected[0]%13?(e.setAttribute("data-selected","true"),e.style.border="2px solid white",selected.push(Number(e.getAttribute("data-id")))):error("Cards must match"):(e.setAttribute("data-selected","false"),e.style.border="none",selected=bubble(selected,Number(e.getAttribute("data-id")))))}function confirmPlay(){"takeplay"==primed?sendPair():"challenge"==primed?challengeForCard():"steal"==primed&&stealSet()}function sendPair(){if(selected.length<2)return void error("Select at least two cards");let e={method:"makeset",newset:selected,clientId:clientId};ws.send(JSON.stringify(e))}function challengeForCard(){if(null==challenge.player)return void error("Choose a player to challenge");if(null==challenge.value)return void error("Choose a card to challenge for");let e={method:"challenge",player:challenge.player,card:challenge.value,clientId:clientId};ws.send(JSON.stringify(e))}function stealSet(){if(null==steal.firstCard||null==steal.name)return void error("Choose a set to steal");let e={method:"steal",name:steal.name,card:steal.firstCard,clientId:clientId};ws.send(JSON.stringify(e))}function removeCards(e,t){for(let n of e)for(let e of t.children)Number(e.getAttribute("data-id"))==n&&e.remove();checkCardOverflow()}function randomCard(){createCard(Math.floor(52*Math.random()),useSuit,document.getElementsByClassName("cardHalf")[0])}function createCard(e,t,n){let l=document.createElement("div");l.classList.add("card"),l.setAttribute("data-value",e%13),l.setAttribute("data-suit",Math.floor(e/13)),l.setAttribute("data-id",e),l.setAttribute("data-selected","false"),l.addEventListener("click",function(){selectCard(this)});let a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("viewBox","0 0 24 24"),a.classList.add("cardValue");let o=document.createElementNS("http://www.w3.org/2000/svg","path");if(o.setAttribute("d",cardIcons[e%13]),a.append(o),l.append(a),!1===t?a.style.fill=cardColors[e%13]:Math.floor(e/13)<2?a.style.fill="rgb(255,30,30)":a.style.fill="white",!0===t)for(let t=0;t<2;t++){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.classList.add("cardSuit"),t.setAttribute("viewBox","0 0 24 24");let n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",suits[Math.floor(e/13)]),Math.floor(e/13)<2?t.style.fill="rgb(255,30,30)":t.style.fill="white",t.append(n),l.append(t)}var s=0;for(let t of n.children)if(t!=n.lastElementChild){if(Number(t.getAttribute("data-value"))>e%13)break;s++}n.children.length>1?n.insertBefore(l,n.children[s]):n.prepend(l),checkCardOverflow()}function plural(e,t){return 1==t?e:e+"S"}function error(e){let t=document.getElementById("error");t.style.display="flex",t.children[0].textContent=e,setTimeout(function(){t.style.display="none"},2500)}function criticalError(e){document.getElementById("criticalError").style.display="flex",document.getElementById("criticalError").children[0].textContent=e}function checkCardOverflow(){var e=document.getElementsByClassName("cardHalf");for(let t of e)t.scrollWidth>t.clientWidth?(console.log("change"),t.style.justifyContent="flex-start",t.lastElementChild.style.display="block"):(t.style.justifyContent="space-evenly",t.lastElementChild.style.display="none")}function bubble(e,t){if(-1==e.indexOf(t))return e;{let n=e.indexOf(t),l=e.slice(0,n),a=e.slice(n+1,e.length);return e=l=l.concat(a),l}}var decodeEntities=function(){var e=document.createElement("div");return function(t){return t&&"string"==typeof t&&(t=(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),e.innerHTML=t,t=e.textContent,e.textContent=""),t}}();
